# Telegraf Configuration with MongoDB Query Plugin (Environment Variable Based)
# This configuration demonstrates how to use the MongoDB querier binary
# with environment variables to define queries

[agent]
  interval = "60s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  flush_interval = "10s"
  collection_jitter = "0s"
  precision = ""
  hostname = ""
  omit_hostname = false

###############################################################################
#                            OUTPUT PLUGINS                                   #
###############################################################################

# SQL Output Plugin - Write metrics to ClickHouse (or any SQL database)
[[outputs.sql]]
  ## Database driver
  ## Supported: postgres, mysql, sqlite, clickhouse
  driver = "clickhouse"

  ## Data source name (DSN)
  ## ClickHouse format: clickhouse://host:port?username=user&password=pass&database=dbname
  data_source_name = "clickhouse://${CLICKHOUSE_HOST}:${CLICKHOUSE_PORT}?username=${CLICKHOUSE_USER}&password=${CLICKHOUSE_PASSWORD}&database=telegraf"

  ## Table name to write metrics to
  table_template = "mongo_metrics"

  ## Timestamp column name and type
  timestamp_column = "timestamp"

  ## Table creation template (automatically creates table if it doesn't exist)
  table_exists_template = "SHOW TABLES LIKE '{{ .Table }}'"

  ## Optional: Create table automatically
  # init_sql = '''
  #   CREATE TABLE IF NOT EXISTS mongo_metrics (
  #     timestamp DateTime,
  #     tags Map(String, String),
  #     fields Map(String, Float64)
  #   ) ENGINE = MergeTree()
  #   ORDER BY timestamp
  # '''

# Alternative: PostgreSQL Output Example
# [[outputs.sql]]
#   driver = "postgres"
#   data_source_name = "host=${POSTGRES_HOST} port=5432 user=${POSTGRES_USER} password=${POSTGRES_PASSWORD} dbname=telegraf sslmode=disable"
#   table_template = "mongo_metrics"
#   timestamp_column = "timestamp"

# Alternative: MySQL Output Example
# [[outputs.sql]]
#   driver = "mysql"
#   data_source_name = "${MYSQL_USER}:${MYSQL_PASSWORD}@tcp(${MYSQL_HOST}:3306)/telegraf"
#   table_template = "mongo_metrics"
#   timestamp_column = "timestamp"

###############################################################################
#                            INPUT PLUGINS                                    #
###############################################################################

# Query 1: User Statistics by Status
[[inputs.exec]]
  ## Command to run the MongoDB querier binary
  commands = ["/usr/local/bin/mongo-telegraf-query"]

  ## Timeout for command execution
  timeout = "30s"

  ## Data format (JSON output from our binary)
  data_format = "json"

  ## Environment variables for this specific query
  environment = [
    "MONGO_URI=${MONGO_URI}",
    "MONGO_DATABASE=myapp",
    "MONGO_COLLECTION=users",
    "QUERY_NAME=user_stats",
    "METRIC_TAGS=metric=users,source=mongodb,environment=production",
    "MONGO_QUERY=[{\"$group\":{\"_id\":\"$status\",\"user_count\":{\"$sum\":1},\"avg_age\":{\"$avg\":\"$age\"}}},{\"$sort\":{\"user_count\":-1}}]"
  ]

  ## Optional: Override collection interval
  # interval = "120s"

# Query 2: Order Totals by Status and Region
[[inputs.exec]]
  commands = ["/usr/local/bin/mongo-telegraf-query"]
  timeout = "30s"
  data_format = "json"

  environment = [
    "MONGO_URI=${MONGO_URI}",
    "MONGO_DATABASE=myapp",
    "MONGO_COLLECTION=orders",
    "QUERY_NAME=order_totals",
    "METRIC_TAGS=metric=orders,source=mongodb,environment=production",
    "MONGO_QUERY=[{\"$group\":{\"_id\":{\"status\":\"$status\",\"region\":\"$region\"},\"total_orders\":{\"$sum\":1},\"total_revenue\":{\"$sum\":\"$amount\"},\"avg_order_value\":{\"$avg\":\"$amount\"}}}]"
  ]

# Query 3: Product Inventory by Category
[[inputs.exec]]
  commands = ["/usr/local/bin/mongo-telegraf-query"]
  timeout = "30s"
  data_format = "json"

  environment = [
    "MONGO_URI=${MONGO_URI}",
    "MONGO_DATABASE=myapp",
    "MONGO_COLLECTION=products",
    "QUERY_NAME=product_inventory",
    "METRIC_TAGS=metric=inventory,source=mongodb,environment=production",
    "MONGO_QUERY=[{\"$group\":{\"_id\":\"$category\",\"total_items\":{\"$sum\":\"$quantity\"},\"unique_products\":{\"$sum\":1},\"avg_price\":{\"$avg\":\"$price\"}}},{\"$sort\":{\"total_items\":-1}}]"
  ]

# Example: Query from a different MongoDB instance
# [[inputs.exec]]
#   commands = ["/usr/local/bin/mongo-telegraf-query"]
#   timeout = "30s"
#   data_format = "json"
#
#   environment = [
#     "MONGO_URI=${ANALYTICS_MONGO_URI}",  # Different MongoDB connection
#     "MONGO_DATABASE=analytics",
#     "MONGO_COLLECTION=events",
#     "QUERY_NAME=analytics_events",
#     "METRIC_TAGS=metric=events,source=mongodb-analytics,environment=production",
#     "MONGO_QUERY=[{\"$group\":{\"_id\":\"$event_type\",\"count\":{\"$sum\":1}}}]"
#   ]

# Example: Complex aggregation with $match and multiple stages
# [[inputs.exec]]
#   commands = ["/usr/local/bin/mongo-telegraf-query"]
#   timeout = "30s"
#   data_format = "json"
#
#   environment = [
#     "MONGO_URI=${MONGO_URI}",
#     "MONGO_DATABASE=myapp",
#     "MONGO_COLLECTION=transactions",
#     "QUERY_NAME=recent_transactions",
#     "METRIC_TAGS=metric=transactions,source=mongodb,timeframe=last_hour",
#     "MONGO_QUERY=[{\"$match\":{\"timestamp\":{\"$gte\":{\"$date\":\"2024-01-01T00:00:00Z\"}}}},{\"$group\":{\"_id\":\"$payment_method\",\"total_amount\":{\"$sum\":\"$amount\"},\"count\":{\"$sum\":1}}}]"
#   ]
