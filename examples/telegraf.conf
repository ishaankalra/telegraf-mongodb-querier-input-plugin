# Telegraf Configuration with MongoDB Query Plugin (Environment Variable Based)
# This configuration demonstrates how to use the MongoDB querier binary
# with environment variables to define find queries using dictionary format

[agent]
  interval = "60s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  flush_interval = "10s"
  collection_jitter = "0s"
  precision = ""
  hostname = ""
  omit_hostname = false

###############################################################################
#                            OUTPUT PLUGINS                                   #
###############################################################################

# SQL Output Plugin - Write metrics to ClickHouse (or any SQL database)
[[outputs.sql]]
  ## Database driver
  ## Supported: postgres, mysql, sqlite, clickhouse
  driver = "clickhouse"

  ## Data source name (DSN)
  ## ClickHouse format: clickhouse://host:port?username=user&password=pass&database=dbname
  data_source_name = "clickhouse://${CLICKHOUSE_HOST}:${CLICKHOUSE_PORT}?username=${CLICKHOUSE_USER}&password=${CLICKHOUSE_PASSWORD}&database=telegraf"

  ## Table name to write metrics to
  table_template = "mongo_metrics"

  ## Timestamp column name and type
  timestamp_column = "timestamp"

  ## Table creation template (automatically creates table if it doesn't exist)
  table_exists_template = "SHOW TABLES LIKE '{{ .Table }}'"

  ## Optional: Create table automatically
  # init_sql = '''
  #   CREATE TABLE IF NOT EXISTS mongo_metrics (
  #     timestamp DateTime,
  #     tags Map(String, String),
  #     fields Map(String, Float64)
  #   ) ENGINE = MergeTree()
  #   ORDER BY timestamp
  # '''

# Alternative: PostgreSQL Output Example
# [[outputs.sql]]
#   driver = "postgres"
#   data_source_name = "host=${POSTGRES_HOST} port=5432 user=${POSTGRES_USER} password=${POSTGRES_PASSWORD} dbname=telegraf sslmode=disable"
#   table_template = "mongo_metrics"
#   timestamp_column = "timestamp"

# Alternative: MySQL Output Example
# [[outputs.sql]]
#   driver = "mysql"
#   data_source_name = "${MYSQL_USER}:${MYSQL_PASSWORD}@tcp(${MYSQL_HOST}:3306)/telegraf"
#   table_template = "mongo_metrics"
#   timestamp_column = "timestamp"

###############################################################################
#                            INPUT PLUGINS                                    #
###############################################################################

# Query 1: Active Users
[[inputs.exec]]
  ## Command to run the MongoDB querier binary
  commands = ["/usr/local/bin/mongo-telegraf-query"]

  ## Timeout for command execution
  timeout = "30s"

  ## Data format (JSON output from our binary)
  data_format = "json"

  ## Environment variables for this specific query
  environment = [
    "MONGO_URI=${MONGO_URI}",
    "MONGO_DATABASE=myapp",
    "MONGO_COLLECTION=users",
    "QUERY_NAME=active_users",
    "METRIC_TAGS=metric=users,source=mongodb,environment=production,status=active",
    "MONGO_QUERY={\"status\":\"active\"}"
  ]

  ## Optional: Override collection interval
  # interval = "120s"

# Query 2: Completed Orders
[[inputs.exec]]
  commands = ["/usr/local/bin/mongo-telegraf-query"]
  timeout = "30s"
  data_format = "json"

  environment = [
    "MONGO_URI=${MONGO_URI}",
    "MONGO_DATABASE=myapp",
    "MONGO_COLLECTION=orders",
    "QUERY_NAME=completed_orders",
    "METRIC_TAGS=metric=orders,source=mongodb,environment=production,status=completed",
    "MONGO_QUERY={\"status\":\"completed\"}"
  ]

# Query 3: Electronics Products
[[inputs.exec]]
  commands = ["/usr/local/bin/mongo-telegraf-query"]
  timeout = "30s"
  data_format = "json"

  environment = [
    "MONGO_URI=${MONGO_URI}",
    "MONGO_DATABASE=myapp",
    "MONGO_COLLECTION=products",
    "QUERY_NAME=electronics_products",
    "METRIC_TAGS=metric=products,source=mongodb,environment=production,category=electronics",
    "MONGO_QUERY={\"category\":\"electronics\"}"
  ]

# Query 4: All Users (No Filter)
[[inputs.exec]]
  commands = ["/usr/local/bin/mongo-telegraf-query"]
  timeout = "30s"
  data_format = "json"

  environment = [
    "MONGO_URI=${MONGO_URI}",
    "MONGO_DATABASE=myapp",
    "MONGO_COLLECTION=users",
    "QUERY_NAME=all_users",
    "METRIC_TAGS=metric=users,source=mongodb,environment=production",
    "MONGO_QUERY={}"
  ]

# Example: Query from a different MongoDB instance
# [[inputs.exec]]
#   commands = ["/usr/local/bin/mongo-telegraf-query"]
#   timeout = "30s"
#   data_format = "json"
#
#   environment = [
#     "MONGO_URI=${ANALYTICS_MONGO_URI}",  # Different MongoDB connection
#     "MONGO_DATABASE=analytics",
#     "MONGO_COLLECTION=events",
#     "QUERY_NAME=analytics_events",
#     "METRIC_TAGS=metric=events,source=mongodb-analytics,environment=production",
#     "MONGO_QUERY={\"event_type\":\"purchase\"}"
#   ]

# Example: Query with multiple conditions
# [[inputs.exec]]
#   commands = ["/usr/local/bin/mongo-telegraf-query"]
#   timeout = "30s"
#   data_format = "json"
#
#   environment = [
#     "MONGO_URI=${MONGO_URI}",
#     "MONGO_DATABASE=myapp",
#     "MONGO_COLLECTION=orders",
#     "QUERY_NAME=us_west_completed_orders",
#     "METRIC_TAGS=metric=orders,source=mongodb,region=us-west",
#     "MONGO_QUERY={\"status\":\"completed\",\"region\":\"us-west\"}"
#   ]

# Example: Query with $in operator
# [[inputs.exec]]
#   commands = ["/usr/local/bin/mongo-telegraf-query"]
#   timeout = "30s"
#   data_format = "json"
#
#   environment = [
#     "MONGO_URI=${MONGO_URI}",
#     "MONGO_DATABASE=myapp",
#     "MONGO_COLLECTION=users",
#     "QUERY_NAME=premium_users",
#     "METRIC_TAGS=metric=users,source=mongodb,tier=premium",
#     "MONGO_QUERY={\"tier\":{\"$in\":[\"premium\",\"enterprise\"]}}"
#   ]
